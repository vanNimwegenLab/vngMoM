---
title: "Demo script for mother machine data analysed with MoMA"
output: html_document
---


```{r variables, include=FALSE}
dt <- 3             # frame intervall (min)
dl <- 0.065         # pixel size (µm)
vertical_cutoff <- 4 / dl   # after it touched this coordinate a cell is discarded

proj_path <- "~/Documents/Biozentrum/Projects/vngWetLabR/mother_machine/example/"
r_scripts_path <- c("~/Documents/Biozentrum/Projects/vngWetLabR/mother_machine",
                  "~/Documents/Biozentrum/Projects/vngWetLabR/ggplot")
perl_scripts_path <- "~/Documents/Biozentrum/Projects/vngWetLabR/mother_machine"
data2preproc <- function(.d) sub('/data/*', '/preproc/', .d) # store cache file in preproc subdir

date_cond <- c("20160318"="lac_lowillum")

condition_ts <- rbind(data.frame(duration=1440, medium='lactose', condition='lac_lowillum') #,
                      # data.frame(duration=c(360, 240, 240, 240, 240, 240),
                      #            medium=c('glucose', 'lactose', 'glucose', 'lactose', 'glucose', 'lactose'),
                      #            condition='switch_4h')
)

# # save environment (but `pls`)
# myvars <- ls(all.names = TRUE)
# save(list=myvars[which(myvars!='pls')], file=".RData", envir=.GlobalEnv)

```


```{r settings}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE) # , include=FALSE

# set working environment
invisible(sapply(
  list.files(r_scripts_path, pattern="\\.[Rr]$", full.names=TRUE, ignore.case=TRUE), 
  source, .GlobalEnv))
setwd(proj_path)

library(parallel)
numCores <- min(30, detectCores()-1) # do not use more than 30 cores

library(multidplyr)
mycluster <- create_cluster(numCores)
for (.l in mylibs) { mycluster %>% cluster_library(.l) }

```


Load all frames in a dataframe:

```{r}
condition_ts <- condition_ts %>% group_by(condition) %>% 
  mutate(t_start=cumsum(c(0, duration[-(length(duration))])),
         t_end=cumsum(duration))

myfiles <- list.files("./data", ".*\\d+\\.csv", recursive=TRUE, full.names=TRUE)
nc <- min(length(myfiles), length(mycluster)) # this is a dirty hack because multiplyr crashes with less shards than cores

# load perl scripts output to dataframes (using parallel lapply)
myframes <- dplyr::data_frame(path=myfiles) %>%
  group_by(path) %>%
  partition(path, cluster=mycluster[1:nc] %>%
              cluster_assign_func(data2preproc, load_timm_data, parse_frames_stats, compute_genealogy, which_touch_exit, which_to_progeny) %>%
              cluster_assign_obj(perl_scripts_path, dt, dl, vertical_cutoff) ) %>%
  do((function(.df){
    # browser()
    .l <- try( load_timm_data(.df$path, perl_scripts_path, .verbose=TRUE, .data2preproc=data2preproc, .force=TRUE))
    if ('frames' %in% names(.l)) {
      return( .l$frames %>%
                mutate(time_sec=frame*dt*60, length_um=length_pixel*dl,
                       discard_start=(time_sec < 2*3600)) %>%
                # remove frames after touching the exit
                group_by(id) %>%
                mutate(discard_top=which_touch_exit(vertical_top, vertical_cutoff)) %>%
                mutate(discard_top=ifelse(discard_start, FALSE, discard_top)) %>% # not in the preexpt step (2h)
                mutate(end_type=ifelse(any(discard_top), 'exit', end_type)) %>% # update end_type
                # remove daughters of cells that touched the exit
                ungroup %>%
                mutate(discard_top=which_to_progeny(discard_top, cid)) )
    } else {
      return (data.frame())
    }
  })(.)) %>%
  collect() %>% 
  group_by(date, pos, gl, id) %>%
  mutate(start_time=first(time_sec), end_time=last(time_sec),
         b_rank=round(mean(total_cell_in_lane - cell_num_in_lane))) %>% 
  #   filter(discard_top==FALSE) %>%
  ungroup %>% 
  mutate(condition=date_cond[as.character(date)],
         vertical_center=(vertical_bottom + vertical_top)/2,
         cell=paste(date, pos, gl, id, sep='.'))

autofluo_per_um <- 422.8 / 8
fp_per_dn <- 1

autofluo_predict <- function(.h) .h * autofluo_per_um
myframes <- myframes %>%
  mutate(fluogfp_amplitude = fluo_amplitude - autofluo_predict(length_um),
         gfp_nb = fluogfp_amplitude * fp_per_dn)

```


if you don't want to rely on `multidplyr`, you can use `multicore` instead. However, `multicore` functions (e.g. `mclapply`) don't play nicely with R GUI: analysing files that have not already been preprocessed by perl scripts causes any R GUI (e.g. RStudio) to hang forever. To circumvent this issue, it is recommended to run your analysis file from the command-line R in this case using `source( 'mother_machine_example.R' )` or  in the case of Rmarkdown file
`source( knitr::purl('mother_machine_example.Rmd', output=tempfile()) )`.

```{r eval=FALSE, collapse=TRUE}
# NB: creating a list of dataframes and rbind them at last is faster than using rbind in a loop
l_data <- mclapply(myfiles, 
                function(.f) { try( load_timm_data(.f, perl_scripts_path, .verbose=TRUE, .data2preproc=data2preproc, .force=FALSE)) }, #) #,
                 mc.cores=numCores)

myframes_mc <- l_data %>% 
  mclapply(function(.l) {
    if ('frames' %in% names(.l)) {
      .l$frames %>%
        mutate(time_sec=frame*dt*60, length_um=length_pixel*dl,
               discard_start=(time_sec < 2*3600)) %>% 
        # remove frames after touching the exit
        group_by(id) %>%
        mutate(discard_top=which_touch_exit(vertical_top, vertical_cutoff)) %>% 
        mutate(discard_top=ifelse(discard_start, FALSE, discard_top)) %>% # not in the preexpt step (2h)
        mutate(end_type=ifelse(any(discard_top), 'exit', end_type)) %>% # update end_type
        # remove daughters of cells that touched the exit
        ungroup %>%
        mutate(discard_top=which_to_progeny(discard_top, cid))
      }
    }) %>% 
  do.call(rbind, .)

```


Compute statistics per cell:

```{r}
mycells <- filter(myframes, condition!='switch', !discard_top) %>%
  # group_by(date, pos, gl, id, parent_id, genealogy) %>%
  partition(condition, date, pos, gl, id, parent_id, genealogy, cluster=mycluster) %>%
  filter(!any(discard_start), end_type=='div') %>% # full cell cycles only
  filter(n()>4) %>% # at least 4 time points
  do((function(.df) {
    # browser()
    
    .mod_ll_t <- lm( log(length_um)~time_sec, .df)  # use fastLm() for predict
    # .mod_ll_t <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
    .mod_lg_t <- fastLmPure( cbind(1, .df$time_sec), log(.df$gfp_nb) )
    .mod_l_t <- fastLmPure( cbind(1, .df$time_sec), .df$length_um )
    .mod_g_t <- fastLmPure( cbind(1, .df$time_sec), .df$gfp_nb )
    .mod_g_l <- fastLmPure( cbind(1, .df$length_um), .df$gfp_nb )

    .time_birth <- first(.df$time_sec)
    .time_div <- last(.df$time_sec)
    .logl <- predict(.mod_ll_t, se.fit=TRUE)
    data.frame(npoints=.mod_ll_t$df.residual+1,
               time_birth=.time_birth, time_div=.time_div, 
               cell_num_from_top=mean(.df$cell_num_in_lane),
               cell_num_from_bottom=mean(.df$total_cell_in_lane-.df$cell_num_in_lane), 
               loglength_start=first(.logl$fit), loglength_startse=first(.logl$se.fit), 
               loglength_end=last(.logl$fit), loglength_endse=last(.logl$se.fit), 
               logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=summary(.mod_ll_t)$coefficients[2,2], 
               # logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=.mod_ll_t$stderr[2], 
               logl_time_r2=corPearson(.df$time_sec, log(.df$length_um))^2,
               logg_time_slope=.mod_lg_t$coefficients[2], logg_time_slopesd=.mod_lg_t$stderr[2], 
               logg_time_r2=corPearson(.df$time_sec, log(.df$gfp_nb))^2,
               l_time_slope=.mod_l_t$coefficients[2], l_time_slopesd=.mod_l_t$stderr[2], 
               l_time_r2=corPearson(.df$time_sec, .df$length_um)^2,
               g_time_slope=.mod_g_t$coefficients[2], g_time_slopesd=.mod_g_t$stderr[2], 
               g_time_r2=corPearson(.df$time_sec, .df$gfp_nb)^2,
               g_l_slope=.mod_g_l$coefficients[2], g_l_slopesd=.mod_g_l$stderr[2], 
               g_l_r2=corPearson(.df$length_um, log(.df$gfp_nb))^2)
  })(.) ) %>% 
  collect() %>% 
  arrange(condition, date, pos, gl, id)

print(mycells)
```


Plot cell traces for length and fluo:

```{r eval=FALSE}

# Plot overall experiment
pls <- myframes %>% 
  # filter((date=='20150703' & pos==0 & gl==7))%>% 
  group_by(condition, date, pos, gl) %>%
  # partition(condition, date, pos, gl, cluster=mycluster) %>%
  do(pll=(function(.df){
    # browser()
    if (dim(filter(.df, !discard_top))[1] == 0) return(list())
    .cond <- unique(.df$condition)
    .fill <- brewer.pal(3, 'Set1')
    .hmin <- max(1.2,  min(filter(.df, !discard_top)$length_um) )
    .hrange <- (max(filter(.df, !discard_top)$length_um)-.hmin) / 2
    .fmin <- min(filter(.df, !discard_top)$gfp_nb)
    .frange <- (max(filter(.df, !discard_top)$gfp_nb)-.fmin) / 2
    
    # compute connections to parent
    .df <- mutate(.df, b_rank=ifelse(b_rank>6, 6, b_rank)) 
    .df_div <- filter(.df, !discard_top) %>% 
      group_by(id) %>% 
      do((function(.dfgl, .dfc) { # compute_div_between_facets
      # .dfgl: dataframe of the entire GL
      # .dfc: dataframe of the current cell
        if (unique(.dfc$parent_id) < 0) return(data.frame())
        .dfp <- filter(.dfgl, id==unique(.dfc$parent_id))
        
        if (unique(.dfc$b_rank) == unique(.dfp$b_rank)) {
          .length_ump <- filter(.dfp, time_sec==max(time_sec))$length_um
          .gfp_nbp <- filter(.dfp, time_sec==max(time_sec))$gfp_nb
          .out <- filter(.dfc, time_sec==min(time_sec)) %>%
            select(id, b_rank, time_sec, length_um, gfp_nb) %>%
            mutate(time_secp=time_sec-dt*60, length_ump=.length_ump, gfp_nbp=.gfp_nbp)
        }
        if (unique(.dfc$b_rank) > unique(.dfp$b_rank)) {
          .out <- bind_rows(
            filter(ungroup(.dfc), time_sec==min(time_sec)) %>%
              select(id, b_rank, time_sec, length_um, gfp_nb) %>%
              mutate(time_secp=time_sec-dt*60/2, length_ump=0, gfp_nbp=-Inf),
            filter(ungroup(.dfp), time_sec==max(time_sec)) %>%
              select(id, b_rank, time_sec, length_um, gfp_nb) %>%
              mutate(id=unique(.dfc$id), time_secp=time_sec+dt*60/2, length_ump=Inf, gfp_nbp=Inf) )
          if(diff(.out$b_rank) < -1) {
            .out <- rbind(.out,
                          data.frame(id=unique(.dfc$id), b_rank=(min(.out$b_rank)+1):(max(.out$b_rank)-1),
                                     time_sec=min(.dfc$time_sec)-dt*60/2, time_secp=min(.dfc$time_sec)-dt*60/2,
                                     length_um=0, length_ump=Inf, gfp_nb=-Inf, gfp_nbp=Inf))
          }
        }
        return(.out)
      })(.df, .))
    
    custom_labels <- function (.str) {
      .labels <- paste('rank:', .str)
      .labels[.labels=='rank: -1'] <- 'all'
      .labels[.labels=='rank: 6'] <- 'rank: >= 6'
      return(.labels)
    }
          
    list(
      l = ggplot() +
        facet_grid(b_rank~., scales='free_y', as.table=FALSE, labeller=as_labeller(custom_labels)) +
        # facets alternated background
        geom_rect(aes(xmin=-Inf, xmax=Inf, ymin=0, ymax=Inf), alpha=.05, data=data.frame(b_rank=seq(0, 6, 2))) +
        # show medium bar
        geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=hmin, ymax=hmax, fill=medium, group=1), size=0.2, data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, hmin=.hmin-.25, hmax=.hmin-.1)) +
        geom_vline(aes(xintercept=t_start*60 - 2*3600, group=1), alpha=.2, size=.5, data=filter(condition_ts, condition==.cond)) +
        geom_text(aes(x=60*(t_start+(t_end-t_start)/2-120), y=h, label=medium, group=1), col='white', data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, h=.hmin-.2), size=2, hjust=0.5, vjust=0) +
        # show divisions (lty='11' means densely dotted line)
        geom_segment(aes(x=time_sec - 2*3600, xend=time_secp - 2*3600, y=length_um, yend=length_ump, col=factor(id)), alpha=.3, lty='11', data=.df_div) + 
        # show cell traces
        geom_path(aes(time_sec - 2*3600, length_um, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff)) +
        geom_text(aes(time_sec - 2*3600, length_um, col=factor(id), label=id), size=2, hjust=0, vjust=1,
                  data=filter(.df, !discard_top) %>% group_by(id) %>% filter(row_number()==1) ) +
        # show all traces in one panel
        geom_path(aes(time_sec - 2*3600, length_um, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff) %>% mutate(b_rank=-1)) +
        # mask early frames (requires a dummy df!)
        geom_rect(aes(xmin=-Inf, xmax=0, ymin=0, ymax=Inf, group=1), fill='white', alpha=.6, col='transparent', data=data.frame(a=1)) +
        scale_colour_periodic_brewer(guide='none') + 
        scale_fill_manual(values=c('glucose'=.fill[1], 'lactose'=.fill[2]), guide='none') +
        scale_x_hours(4) +
        scale_y_continuous(trans='log2', breaks=2:4) +
        labs(y='length (µm)') +
        theme(panel.margin = unit(0, "lines"), panel.border=element_blank()),
      
      ft = ggplot() +
        facet_grid(b_rank~., scales='free_y', as.table=FALSE, labeller=as_labeller(custom_labels)) +
        # facets alternated background
        geom_rect(aes(xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf), alpha=.05, data=data.frame(b_rank=seq(0, 6, 2))) +
        # show medium bar
        geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=fmin, ymax=fmax, fill=medium), size=0.2, data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, fmin=.fmin-.frange/2.5, fmax=.fmin-.frange/5)) +
        geom_vline(aes(xintercept=t_start*60 - 2*3600), alpha=.2, size=.5, data=filter(condition_ts, condition==.cond, t_start>0)) +
        geom_text(aes(x=60*(t_start+(t_end-t_start)/2-120), y=f, label=medium), col='white', data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, f=.fmin-.frange/3), size=2, hjust=0.5, vjust=0) +
        # show divisions (lty='11' means densely dotted line using hex notation)
        geom_segment(aes(x=time_sec - 2*3600, xend=time_secp - 2*3600, y=gfp_nb, yend=gfp_nbp, col=factor(id)), alpha=.3, lty='11', data=.df_div) + 
        # show cell traces
        geom_path(aes(time_sec - 2*3600, gfp_nb, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff)) +
        geom_text(aes(time_sec - 2*3600, gfp_nb, col=factor(id), label=id), size=2, hjust=0, vjust=1,
                  data=filter(.df, !discard_top) %>% group_by(id) %>% filter(row_number()==1) ) +
        # show all traces in one panel
        geom_path(aes(time_sec - 2*3600, gfp_nb, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff) %>% mutate(b_rank=-1)) +
        # mask early frames (requires a dummy df!)
        geom_rect(aes(xmin=-Inf, xmax=0, ymin=-Inf, ymax=Inf, group=1), fill='white', alpha=.6, data=data.frame(a=1)) +
        scale_colour_periodic_brewer(guide='none') + 
        scale_fill_manual(values=c('glucose'=.fill[1], 'lactose'=.fill[2]), guide='none') +
        scale_x_hours(4) +
        labs(y='total GFP per cell (molecules)') +
        theme(panel.margin = unit(0, "lines"), panel.border=element_blank()),

      fc = ggplot() +
        facet_grid(b_rank~., scales='free_y', as.table=FALSE, labeller=as_labeller(custom_labels)) +
        # facets alternated background
        geom_rect(aes(xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf), alpha=.05, data=data.frame(b_rank=seq(0, 6, 2))) +
        # show medium bar
        geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=fmin/2, ymax=fmax/2, fill=medium), size=0.2, data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, fmin=.fmin-.frange/2.5, fmax=.fmin-.frange/5)) +
        geom_vline(aes(xintercept=t_start*60 - 2*3600), alpha=.2, size=.5, data=filter(condition_ts, condition==.cond, t_start>0)) +
        geom_text(aes(x=60*(t_start+(t_end-t_start)/2-120), y=f/2, label=medium), col='white', data=filter(condition_ts, condition==.cond) %>% mutate(b_rank=-1, f=.fmin-.frange/3), size=2, hjust=0.5, vjust=0) +
        # show divisions (lty='11' means densely dotted line using hex notation)
        geom_segment(aes(x=time_sec - 2*3600, xend=time_secp - 2*3600, y=gfp_nb/length_um, yend=gfp_nbp/length_um, col=factor(id)), alpha=.3, lty='11', data=.df_div) + 
        # show cell traces
        geom_path(aes(time_sec - 2*3600, gfp_nb/length_um, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff)) +
        geom_text(aes(time_sec - 2*3600, gfp_nb/length_um, col=factor(id), label=id), size=2, hjust=0, vjust=1,
                  data=filter(.df, !discard_top) %>% group_by(id) %>% filter(row_number()==1) ) +
        # show all traces in one panel
        geom_path(aes(time_sec - 2*3600, gfp_nb/length_um, col=factor(id)), data=filter(.df, !discard_top, vertical_top>vertical_cutoff) %>% mutate(b_rank=-1)) +
        # mask early frames (requires a dummy df!)
        geom_rect(aes(xmin=-Inf, xmax=0, ymin=-Inf, ymax=Inf, group=1), fill='white', alpha=.6, data=data.frame(a=1)) +
        scale_colour_periodic_brewer(guide='none') + 
        scale_fill_manual(values=c('glucose'=.fill[1], 'lactose'=.fill[2]), guide='none') +
        scale_x_hours(4) +
        labs(y='GFP concentration (molecules/µm)') +
        theme(panel.margin = unit(0, "lines"), panel.border=element_blank())
    )
  })(.)) 


pdf('plots/example_path_length.pdf', width=12, height=10)
for (i in 1:dim(pls)[1]) {
  if ('l' %in% names(pls[[i, 'pll']]))
    plot(pls[[i, 'pll']] [['l']] + 
           labs(title=sprintf("%s  pos:%02d  GL:%02d", pls[[i, "date"]], pls[[i, "pos"]], pls[[i, "gl"]])))
}
dev.off()

pdf('plots/example_path_fluotot.pdf', width=12, height=10)
for (i in 1:dim(pls)[1]) {
  if ('ft' %in% names(pls[[i, 'pll']]))
  plot(pls[[i, 'pll']] [['ft']] + 
         labs(title=sprintf("%s  pos:%02d  GL:%02d", pls[[i, "date"]], pls[[i, "pos"]], pls[[i, "gl"]])))
}
dev.off()

pdf('plots/example_path_fluoconc.pdf', width=12, height=10)
for (i in 1:dim(pls)[1]) {
  if ('fc' %in% names(pls[[i, 'pll']]))
  plot(pls[[i, 'pll']] [['fc']] + 
         labs(title=sprintf("%s  pos:%02d  GL:%02d", pls[[i, "date"]], pls[[i, "pos"]], pls[[i, "gl"]])))
}
dev.off()

```

